  WITH RECURSIVE temp_jobs AS (                                                                                     
  SELECT (j).*, pg_try_advisory_lock((j).id) AS locked                        
  FROM (                                                                      
    SELECT j                                                                  
    FROM jobs AS j                                                            
    AND process_next <= now()                                                 
    ORDER BY process_next, job_id                                             
    LIMIT 1                                                                   
  ) AS t1                                                                                                   
  UNION ALL (                                                                 
    SELECT (j).*, pg_try_advisory_lock((j).id) AS locked                      
    FROM (                                                                    
      SELECT (                                                                
        SELECT j                                                              
        FROM jobs AS j                                                        
        WHERE queue = $1::text                                                
        AND run_at <= now()                                                     
        AND (process_next, id) > (temp_table.process_next, temp_table.id)  
        ORDER BY process_next, job_id                                         
        LIMIT 1                                                               
      ) AS j                                                                  
      FROM job                                                                
      WHERE NOT job.locked   
      LIMIT 1                                                                 
    ) AS t1                                                                   
  )                                                                           
)                                                                                                             
SELECT * FROM temp_table where locked;